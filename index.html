<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê°ê´€ì‹ ì§ˆë¬¸ ìƒì„±ê¸°</title>
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      font-family: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    }
    .copy-btn {
      opacity: 0;
      transition: opacity 0.2s;
    }
    .copy-section:hover .copy-btn {
      opacity: 1;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
  <div class="max-w-2xl mx-auto">
    
    <!-- í—¤ë” -->
    <div class="text-center mb-6">
      <h1 class="text-2xl font-bold text-gray-900">ğŸ“‹ ê°ê´€ì‹ ì§ˆë¬¸ ìƒì„±ê¸°</h1>
      <p class="text-sm text-gray-600">ì…ë ¥ ë‚´ìš©ì„ ê°ê´€ì‹ ì§ˆë¬¸ìœ¼ë¡œ ìë™ ë³€í™˜</p>
    </div>

    <!-- ë©”ì¸ ì¹´ë“œ -->
    <div class="bg-white rounded-xl shadow-lg p-6">
      
      <!-- ì…ë ¥ ì„¹ì…˜ -->
      <div class="mb-6">
        <label class="block text-sm font-bold text-gray-700 mb-2">âœï¸ ì§ˆë¬¸ ì…ë ¥</label>
        <textarea 
          id="input"
          placeholder="ì˜ˆì‹œ 1: ê¸€ì“°ê¸° ê´€ì‹¬ ë¶„ì•¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” (ë³µìˆ˜ì„ íƒ)&#10;* ì—ì„¸ì´&#10;* ì†Œì„¤&#10;* ìì„œì „&#10;* ì‹¤ìš©ì„œ&#10;&#10;ì˜ˆì‹œ 2: ìë…€ì˜ í•™ë…„ì„ ì„ íƒí•´ì£¼ì„¸ìš”&#10;* ì´ˆë“± 1~3í•™ë…„&#10;* ì´ˆë“± 4~6í•™ë…„&#10;* ì¤‘í•™êµ 1í•™ë…„"
          class="w-full h-32 p-3 border-2 border-gray-200 rounded-lg resize-none focus:border-indigo-400 focus:outline-none text-sm"
        ></textarea>
      </div>

      <!-- ëª…í™•í™” ì§ˆë¬¸ ì˜ì—­ (ìˆ¨ê¹€) -->
      <div id="clarifySection" class="mb-6 p-4 bg-yellow-50 border-2 border-yellow-200 rounded-lg hidden">
        <p class="text-sm font-bold text-yellow-800 mb-2">ğŸ’¡ ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
        <p id="clarifyQuestion" class="text-sm text-gray-700 mb-3"></p>
        <input 
          id="clarifyInput"
          type="text"
          placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”"
          class="w-full p-2 border-2 border-yellow-300 rounded-lg text-sm focus:border-yellow-400 focus:outline-none mb-2"
        />
        <button 
          id="clarifySubmitBtn"
          class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 text-sm"
        >
          ë‹µë³€ ì œì¶œ
        </button>
      </div>

      <button 
        id="generateBtn"
        class="w-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold py-3 px-6 rounded-lg hover:from-indigo-600 hover:to-purple-600 disabled:opacity-50 transition-all shadow-md mb-4"
      >
        âœ¨ ê°ê´€ì‹ ì§ˆë¬¸ ìƒì„±í•˜ê¸°
      </button>

      <div id="error" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm hidden"></div>

      <!-- ê²°ê³¼ ì˜ì—­ -->
      <div id="resultSection" class="hidden">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-bold text-gray-800">ğŸ“‹ ê²°ê³¼</h2>
        </div>

        <div id="result" class="max-h-96 overflow-y-auto p-4 border-2 border-gray-200 rounded-lg bg-gray-50">
        </div>

        <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
          <p class="text-xs text-green-800">
            ğŸ’¡ ê° í•­ëª© ì˜†ì˜ ë³µì‚¬ ë²„íŠ¼(ğŸ“‹)ì„ í´ë¦­í•˜ì—¬ ê°œë³„ ë³µì‚¬ ê°€ëŠ¥
          </p>
        </div>
      </div>

      <!-- ê°€ì´ë“œ ì„¹ì…˜ -->
      <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-xs font-bold text-blue-800 mb-2">ğŸ“– ì‚¬ìš© ê°€ì´ë“œ</p>
        <ul class="text-xs text-blue-700 space-y-1">
          <li>â€¢ ì§ˆë¬¸ ì œëª©ê³¼ ì˜µì…˜(*ë¡œ ì‹œì‘)ì„ ì…ë ¥í•˜ì„¸ìš”</li>
          <li>â€¢ ì„¤ëª…ì´ í•„ìš”í•˜ë©´ ì§ˆë¬¸ ì•„ë˜ ì¶”ê°€í•˜ì„¸ìš”</li>
          <li>â€¢ ì—¬ëŸ¬ ì§ˆë¬¸ì„ í•œ ë²ˆì— ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
          <li>â€¢ ì˜µì…˜ì€ íƒœê·¸ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ì§§ì€ í˜•íƒœë¡œ ìƒì„±ë©ë‹ˆë‹¤</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    const input = document.getElementById('input');
    const generateBtn = document.getElementById('generateBtn');
    const clarifySection = document.getElementById('clarifySection');
    const clarifyQuestion = document.getElementById('clarifyQuestion');
    const clarifyInput = document.getElementById('clarifyInput');
    const clarifySubmitBtn = document.getElementById('clarifySubmitBtn');
    const errorDiv = document.getElementById('error');
    const resultSection = document.getElementById('resultSection');
    const resultDiv = document.getElementById('result');

    let originalInput = '';

    generateBtn.addEventListener('click', async () => {
      const inputText = input.value.trim();
      
      if (!inputText) {
        showError('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      originalInput = inputText;
      await clarifyAndGenerate(inputText);
    });

    clarifySubmitBtn.addEventListener('click', async () => {
      const answer = clarifyInput.value.trim();
      
      if (!answer) {
        showError('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const combinedInput = `${originalInput}\n\nì¶”ê°€ ì •ë³´: ${answer}`;
      clarifySection.classList.add('hidden');
      await generateQuestion(combinedInput);
    });

async function clarifyAndGenerate(inputText) {
  generateBtn.disabled = true;
  generateBtn.textContent = 'â³ í™•ì¸ ì¤‘...';
  hideError();

  try {
    const response = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ input: inputText, mode: 'clarify' })
    });

    // ì‘ë‹µ í™•ì¸
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      const text = await response.text();
      console.error('Non-JSON response:', text);
      showError('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      generateBtn.disabled = false;
      generateBtn.textContent = 'âœ¨ ê°ê´€ì‹ ì§ˆë¬¸ ìƒì„±í•˜ê¸°';
      return;
    }

    const data = await response.json();

    if (data.status === 'ready') {
      await generateQuestion(inputText);
    } else if (data.status === 'clarify') {
      clarifyQuestion.textContent = data.question;
      clarifySection.classList.remove('hidden');
      generateBtn.disabled = false;
      generateBtn.textContent = 'âœ¨ ê°ê´€ì‹ ì§ˆë¬¸ ìƒì„±í•˜ê¸°';
    } else {
      showError('ì˜¤ë¥˜: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      generateBtn.disabled = false;
      generateBtn.textContent = 'âœ¨ ê°ê´€ì‹ ì§ˆë¬¸ ìƒì„±í•˜ê¸°';
    }
  } catch (err) {
    console.error('Error:', err);
    showError('ì˜¤ë¥˜: ' + err.message);
    generateBtn.disabled = false;
    generateBtn.textContent = 'âœ¨ ê°ê´€ì‹ ì§ˆë¬¸ ìƒì„±í•˜ê¸°';
  }
}

    async function generateQuestion(inputText) {
  generateBtn.disabled = true;
  generateBtn.textContent = 'â³ ìƒì„± ì¤‘...';
  hideError();

  try {
    const response = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ input: inputText, mode: 'generate' })
    });

    // ì‘ë‹µ í™•ì¸
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      const text = await response.text();
      console.error('Non-JSON response:', text);
      showError('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      return;
    }

    const data = await response.json();

    if (data.status === 'complete') {
      displayResult(data.result);
      resultSection.classList.remove('hidden');
    } else {
      showError('ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  } catch (err) {
    console.error('Error:', err);
    showError('ì˜¤ë¥˜: ' + err.message);
  } finally {
    generateBtn.disabled = false;
    generateBtn.textContent = 'âœ¨ ê°ê´€ì‹ ì§ˆë¬¸ ìƒì„±í•˜ê¸°';
  }
}

    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = 'âœ…';
        setTimeout(() => {
          button.innerHTML = originalText;
        }, 1500);
      }).catch(err => {
        showError('ë³µì‚¬ ì‹¤íŒ¨: ' + err.message);
      });
    }

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }

    function hideError() {
      errorDiv.classList.add('hidden');
    }

    function displayResult(text) {
      const lines = text.split('\n');
      let html = '';
      let inOptions = false;

      lines.forEach(line => {
        const trimmed = line.trim();
        
        if (!trimmed) {
          return;
        } else if (trimmed === '---') {
          html += '<hr class="my-4 border-gray-300">';
          inOptions = false;
        } else if (trimmed.startsWith('**ì§ˆë¬¸:**')) {
          const content = trimmed.replace('**ì§ˆë¬¸:**', '').trim();
          html += `
            <div class="copy-section relative group mt-3 mb-2">
              <h3 class="text-base font-bold text-indigo-700 inline">ğŸ“Œ ì§ˆë¬¸: ${content}</h3>
              <button onclick="copyToClipboard('${content.replace(/'/g, "\\'")}', this)" class="copy-btn absolute right-0 top-0 ml-2 px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-xs hover:bg-indigo-200">ğŸ“‹</button>
            </div>
          `;
          inOptions = false;
        } else if (trimmed.startsWith('**ì„¤ëª…:**')) {
          const content = trimmed.replace('**ì„¤ëª…:**', '').trim();
          if (content !== 'ì—†ìŒ') {
            html += `
              <div class="copy-section relative group mb-2">
                <p class="text-sm text-gray-600 italic inline">${content}</p>
                <button onclick="copyToClipboard('${content.replace(/'/g, "\\'")}', this)" class="copy-btn absolute right-0 top-0 ml-2 px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200">ğŸ“‹</button>
              </div>
            `;
          }
          inOptions = false;
        } else if (trimmed.startsWith('**ì˜µì…˜:**')) {
          html += `<p class="text-sm font-bold text-gray-700 mt-2 mb-1">ì˜µì…˜:</p>`;
          inOptions = true;
        } else if (trimmed.startsWith('-') && inOptions) {
          const content = trimmed.replace(/^-\s*/, '');
          html += `
            <div class="copy-section relative group ml-2 mb-1">
              <span class="inline-block bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs">ğŸ·ï¸ ${content}</span>
              <button onclick="copyToClipboard('${content.replace(/'/g, "\\'")}', this)" class="copy-btn ml-2 px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs hover:bg-purple-200">ğŸ“‹</button>
            </div>
          `;
        } else {
          html += `<p class="text-sm text-gray-700 mb-1">${trimmed}</p>`;
          inOptions = false;
        }
      });

      resultDiv.innerHTML = html;
    }

    window.copyToClipboard = copyToClipboard;
  </script>
</body>
</html>